{"version":3,"sources":["../src/hook.ts","../src/context.ts","../src/state.ts","../src/provider.tsx","../src/index.ts"],"sourcesContent":["import * as React from \"react\";\nimport { Context } from \"./context\";\nimport { initialState } from \"./state\";\n\nexport function useAuth() {\n  const context = React.useContext(Context);\n\n  if (context === initialState) {\n    throw new Error(\"useAuth must be used within an AuthKitProvider\");\n  }\n\n  return context;\n}\n","\"use client\";\n\nimport * as React from \"react\";\nimport { Client } from \"./types\";\nimport { State, initialState } from \"./state\";\n\nexport interface ContextValue extends Client, State {}\n\nexport const Context = React.createContext<ContextValue>(\n  initialState as ContextValue,\n);\n","import { User } from \"@workos-inc/authkit-js\";\n\nexport interface Impersonator {\n  email: string;\n  reason: string | null;\n}\n\nexport interface State {\n  isLoading: boolean;\n  user: User | null;\n  role: string | null;\n  roles: string[] | null;\n  organizationId: string | null;\n  permissions: string[];\n  featureFlags: string[];\n  impersonator: Impersonator | null;\n}\n\nexport const initialState: State = {\n  isLoading: true,\n  user: null,\n  role: null,\n  roles: null,\n  organizationId: null,\n  permissions: [],\n  featureFlags: [],\n  impersonator: null,\n};\n","\"use client\";\n\nimport * as React from \"react\";\nimport {\n  createClient,\n  getClaims,\n  LoginRequiredError,\n  OnRefreshResponse,\n} from \"@workos-inc/authkit-js\";\nimport { Context } from \"./context\";\nimport { Client, CreateClientOptions } from \"./types\";\nimport { initialState } from \"./state\";\n\ninterface AuthKitProviderProps extends CreateClientOptions {\n  clientId: string;\n  children: React.ReactNode;\n}\n\nexport function AuthKitProvider(props: AuthKitProviderProps) {\n  const {\n    clientId,\n    devMode,\n    apiHostname,\n    https,\n    port,\n    redirectUri,\n    children,\n    onRefresh,\n    onRefreshFailure,\n    onRedirectCallback,\n    refreshBufferInterval,\n  } = props;\n  const [client, setClient] = React.useState<Client>(NOOP_CLIENT);\n  const [state, setState] = React.useState(initialState);\n\n  console.log(\"PROVIDER WEEEEE wat\")\n\n  const handleRefresh = React.useCallback(\n    (response: OnRefreshResponse) => {\n      const {\n        user,\n        accessToken,\n        organizationId = null,\n        impersonator = null,\n      } = response;\n      const {\n        role = null,\n        roles = null,\n        permissions = [],\n        feature_flags: featureFlags = [],\n      } = getClaims(accessToken);\n      setState((prev) => {\n        const next = {\n          ...prev,\n          user,\n          organizationId,\n          role,\n          roles,\n          permissions,\n          featureFlags,\n          impersonator,\n        };\n        return isEquivalentWorkOSSession(prev, next) ? prev : next;\n      });\n      onRefresh?.(response);\n    },\n    [client],\n  );\n\n  React.useEffect(() => {\n    function initialize() {\n      console.log(\"INITIALIZING WEEEEE authkit\")\n      const timeoutId = setTimeout(() => {\n        createClient(clientId, {\n          apiHostname,\n          port,\n          https,\n          redirectUri,\n          devMode,\n          onRedirectCallback,\n          onRefresh: handleRefresh,\n          onRefreshFailure,\n          refreshBufferInterval,\n        }).then(async (client) => {\n          const user = client.getUser();\n          setClient({\n            getAccessToken: client.getAccessToken.bind(client),\n            getUser: client.getUser.bind(client),\n            signIn: client.signIn.bind(client),\n            signUp: client.signUp.bind(client),\n            signOut: client.signOut.bind(client),\n            switchToOrganization: client.switchToOrganization.bind(client),\n          });\n          setState((prev) => ({ ...prev, isLoading: false, user }));\n        });\n      });\n\n      return () => {\n        clearTimeout(timeoutId);\n      };\n    }\n\n    setClient(NOOP_CLIENT);\n    setState(initialState);\n\n    return initialize();\n  }, [clientId, apiHostname, https, port, redirectUri, refreshBufferInterval]);\n\n  return (\n    <Context.Provider value={{ ...client, ...state }}>\n      {children}\n    </Context.Provider>\n  );\n}\n\n// poor-man's \"deep equality\" check\nfunction isEquivalentWorkOSSession(\n  a: typeof initialState,\n  b: typeof initialState,\n) {\n  return (\n    a.user?.updatedAt === b.user?.updatedAt &&\n    a.organizationId === b.organizationId &&\n    a.role === b.role &&\n    a.roles === b.roles &&\n    a.permissions.length === b.permissions.length &&\n    a.permissions.every((perm, i) => perm === b.permissions[i]) &&\n    a.featureFlags.length === b.featureFlags.length &&\n    a.featureFlags.every((flag, i) => flag === b.featureFlags[i]) &&\n    a.impersonator?.email === b.impersonator?.email &&\n    a.impersonator?.reason === b.impersonator?.reason\n  );\n}\n\nconst NOOP_CLIENT: Client = {\n  signIn: async () => {},\n  signUp: async () => {},\n  getUser: () => null,\n  getAccessToken: () => Promise.reject(new LoginRequiredError()),\n  switchToOrganization: () => Promise.resolve(),\n  signOut: async () => {},\n};\n","export { useAuth } from \"./hook\";\nexport { AuthKitProvider } from \"./provider\";\nexport { getClaims } from \"@workos-inc/authkit-js\";\nexport type { Impersonator } from \"./state\";\n"],"mappings":"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","names":["React","React","client","getClaims"]}