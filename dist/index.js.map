{"version":3,"sources":["../src/index.ts","../src/hook.ts","../src/context.ts","../src/state.ts","../src/provider.tsx"],"sourcesContent":["export { useAuth } from \"./hook\";\nexport { AuthKitProvider } from \"./provider\";\nexport { getClaims } from \"@workos-inc/authkit-js\";\nexport type { Impersonator } from \"./state\";\n","import * as React from \"react\";\nimport { Context } from \"./context\";\nimport { initialState } from \"./state\";\n\nexport function useAuth() {\n  const context = React.useContext(Context);\n\n  if (context === initialState) {\n    throw new Error(\"useAuth must be used within an AuthKitProvider\");\n  }\n\n  return context;\n}\n","\"use client\";\n\nimport * as React from \"react\";\nimport { Client } from \"./types\";\nimport { State, initialState } from \"./state\";\n\nexport interface ContextValue extends Client, State {\n  signInWithSeparateTab: (options: { separateTabUrl: string }) => Promise<void>;\n}\n\nexport const Context = React.createContext<ContextValue>(\n  initialState as ContextValue,\n);\n","import { User } from \"@workos-inc/authkit-js\";\n\nexport interface Impersonator {\n  email: string;\n  reason: string | null;\n}\n\nexport interface State {\n  isLoading: boolean;\n  user: User | null;\n  role: string | null;\n  roles: string[] | null;\n  organizationId: string | null;\n  permissions: string[];\n  featureFlags: string[];\n  impersonator: Impersonator | null;\n}\n\nexport const initialState: State = {\n  isLoading: true,\n  user: null,\n  role: null,\n  roles: null,\n  organizationId: null,\n  permissions: [],\n  featureFlags: [],\n  impersonator: null,\n};\n","\"use client\";\n\nimport * as React from \"react\";\nimport {\n  createClient,\n  getClaims,\n  LoginRequiredError,\n  OnRefreshResponse,\n} from \"@workos-inc/authkit-js\";\nimport { Context } from \"./context\";\nimport { Client, CreateClientOptions } from \"./types\";\nimport { initialState } from \"./state\";\n\ninterface AuthKitProviderProps extends CreateClientOptions {\n  clientId: string;\n  children: React.ReactNode;\n}\n\nexport function AuthKitProvider(props: AuthKitProviderProps) {\n  const {\n    clientId,\n    devMode,\n    apiHostname,\n    https,\n    port,\n    redirectUri,\n    children,\n    onRefresh,\n    onRefreshFailure,\n    onRedirectCallback,\n    refreshBufferInterval,\n  } = props;\n  const [client, setClient] = React.useState<Client>(NOOP_CLIENT);\n  const [state, setState] = React.useState(initialState);\n\n  const handleRefresh = React.useCallback(\n    (response: OnRefreshResponse) => {\n      const {\n        user,\n        accessToken,\n        organizationId = null,\n        impersonator = null,\n      } = response;\n      const {\n        role = null,\n        roles = null,\n        permissions = [],\n        feature_flags: featureFlags = [],\n      } = getClaims(accessToken);\n      setState((prev) => {\n        const next = {\n          ...prev,\n          user,\n          organizationId,\n          role,\n          roles,\n          permissions,\n          featureFlags,\n          impersonator,\n        };\n        return isEquivalentWorkOSSession(prev, next) ? prev : next;\n      });\n      onRefresh?.(response);\n    },\n    [client],\n  );\n\n  const signInWithSeparateTab = async ({ separateTabUrl }: { separateTabUrl: string }): Promise<void> => {\n    return new Promise((resolve, reject) => {\n      let intervalHandle: any = null\n      const childWindow = window.open(separateTabUrl, \"_blank\")\n  \n      const handleChildMessage = async (e: MessageEvent) => {\n        console.log(\"HANDLE CHILD MESSAGE\", e, childWindow)\n        if (e.origin !== window.location.origin) return\n        if (e.data.type !== \"WORKOS_AUTH_SUCCESS\") return \n        if (!childWindow) return \n\n        console.log(\"INITIALIZE CLIENT AGAIN\")\n  \n        await initializeClient()\n  \n        clearInterval(intervalHandle)\n        childWindow.close()\n  \n        window.removeEventListener(\"message\", handleChildMessage)\n  \n        resolve()\n      }\n  \n      if (childWindow) {\n        intervalHandle = setInterval(() => {\n          if (childWindow?.closed) {\n            clearInterval(intervalHandle)\n            window.removeEventListener(\"message\", handleChildMessage)\n            reject()\n          }\n        }, 500)\n  \n        window.addEventListener(\"message\", handleChildMessage)\n      }\n\n      resolve()\n    })\n  }\n\n  const initializeClient = () => {\n    console.log(\"INITIALIZE CLIENT 1\")\n    createClient(clientId, {\n      apiHostname,\n      port,\n      https,\n      redirectUri,\n      devMode,\n      onRedirectCallback,\n      onRefresh: handleRefresh,\n      onRefreshFailure,\n      refreshBufferInterval,\n    }).then(async (client) => {\n      const user = client.getUser();\n      setClient({\n        getAccessToken: client.getAccessToken.bind(client),\n        getUser: client.getUser.bind(client),\n        signIn: client.signIn.bind(client),\n        signUp: client.signUp.bind(client),\n        signOut: client.signOut.bind(client),\n        switchToOrganization: client.switchToOrganization.bind(client),\n      });\n      setState((prev) => ({ ...prev, isLoading: false, user }));\n    });\n  }\n\n  React.useEffect(() => {\n    setClient(NOOP_CLIENT);\n    setState(initialState);\n\n    const timeoutId = setTimeout(() => {\n      initializeClient();\n    });\n\n    return () => {\n      clearTimeout(timeoutId);\n    };\n  }, [clientId, apiHostname, https, port, redirectUri, refreshBufferInterval]);\n\n  return (\n    <Context.Provider value={{ \n      ...client, \n      ...state,\n      signInWithSeparateTab,\n    }}>\n      {children}\n    </Context.Provider>\n  );\n}\n\n// poor-man's \"deep equality\" check\nfunction isEquivalentWorkOSSession(\n  a: typeof initialState,\n  b: typeof initialState,\n) {\n  return (\n    a.user?.updatedAt === b.user?.updatedAt &&\n    a.organizationId === b.organizationId &&\n    a.role === b.role &&\n    a.roles === b.roles &&\n    a.permissions.length === b.permissions.length &&\n    a.permissions.every((perm, i) => perm === b.permissions[i]) &&\n    a.featureFlags.length === b.featureFlags.length &&\n    a.featureFlags.every((flag, i) => flag === b.featureFlags[i]) &&\n    a.impersonator?.email === b.impersonator?.email &&\n    a.impersonator?.reason === b.impersonator?.reason\n  );\n}\n\nconst NOOP_CLIENT: Client = {\n  signIn: async () => {},\n  signUp: async () => {},\n  getUser: () => null,\n  getAccessToken: () => Promise.reject(new LoginRequiredError()),\n  switchToOrganization: () => Promise.resolve(),\n  signOut: async () => {},\n};\n"],"mappings":"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","names":["React","React","client","import_authkit_js"]}